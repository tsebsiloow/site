<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒ—ãƒ­ã‚­ã‚·ãƒ–ãƒ©ã‚¦ã‚¶ ZIPï¼‹PDFä¸€ä½“ç‰ˆ</title>

<!-- JSZip / FileSaver / html2pdf -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:system-ui,sans-serif;background:#f8fafc;}
header{background:#fff;padding:10px;display:flex;gap:8px;align-items:center;border-bottom:1px solid #ddd;position:sticky;top:0;}
input,select,button{padding:8px;border-radius:6px;}
input{flex:1;border:1px solid #ccc;}
button{background:#2563eb;color:#fff;border:none;cursor:pointer;}
iframe{width:100%;height:80vh;border:none;}
#status{margin-left:10px;font-size:0.9em;}
</style>
</head>
<body>
<header>
  <input id="urlInput" type="text" placeholder="https://example.com" />
  <select id="proxySelect"></select>
  <button onclick="loadPage()">è¡¨ç¤º</button>
  <button onclick="saveAll()">ğŸ’¾ HTMLï¼‹PDFä¸€ä½“ZIPä¿å­˜</button>
  <span id="status">æº–å‚™OKã€‚</span>
</header>
<iframe id="viewer"></iframe>

<script>
const proxies=[
  'https://api.allorigins.win/raw?url=',
  'https://corsproxy.io/?',
  'https://api.codetabs.com/v1/proxy?quest=',
  'https://thingproxy.freeboard.io/fetch/',
  'https://cors.bridged.cc/',
  'https://proxy.cors.sh/',
  'https://cors.eu.org/',
  'https://proxy.techzbots1.workers.dev/?u=',
  'https://cors-fetch.browserslist.workers.dev/?url='
];

const sel=document.getElementById("proxySelect");
proxies.forEach(p=>{const o=document.createElement("option");o.value=p;o.textContent=p;sel.appendChild(o);});
sel.selectedIndex=Math.floor(Math.random()*proxies.length);

let currentHTML="", currentURL="";
const viewer=document.getElementById("viewer");
const statusEl=document.getElementById("status");
function status(t){statusEl.textContent=t;}

async function loadPage(){
  const url=document.getElementById("urlInput").value.trim();
  if(!url)return alert("URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  currentURL=url;
  status("å–å¾—ä¸­...");
  for(let proxy of proxies){
    try{
      const resp=await fetch(proxy+encodeURIComponent(url));
      if(!resp.ok)continue;
      const text=await resp.text();
      currentHTML=text;
      const blob=new Blob([text],{type:"text/html"});
      viewer.src=URL.createObjectURL(blob);
      status("âœ… ãƒšãƒ¼ã‚¸å–å¾—æˆåŠŸ");
      return;
    }catch(e){}
  }
  status("âŒ å…¨ã¦ã®ãƒ—ãƒ­ã‚­ã‚·ã§å¤±æ•—");
}

async function saveAll(){
  if(!currentHTML)return alert("ãƒšãƒ¼ã‚¸ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„");
  status("ğŸ“¦ ZIPæº–å‚™ä¸­...");
  const zip=new JSZip();
  const parser=new DOMParser();
  const doc=parser.parseFromString(currentHTML,"text/html");

  const assetsToSave=[];

  doc.querySelectorAll('link[rel="stylesheet"][href], script[src], img[src]').forEach(el=>{
    const attr=el.tagName==="LINK"?"href":"src";
    const url=el.getAttribute(attr);
    if(!url)return;
    const abs=new URL(url,currentURL).href;
    assetsToSave.push({el,url:abs,attr});
  });

  // --- å„ãƒªã‚½ãƒ¼ã‚¹ä¿å­˜ï¼ˆéšå±¤å†ç¾ï¼‰ ---
  for(let {el,url,attr} of assetsToSave){
    try{
      const blob=await fetchResource(url);
      const pathname=(new URL(url)).pathname.replace(/^\/+/,'');
      const path=pathname||"misc/"+Date.now();
      zip.file(path,blob);
      el.setAttribute(attr,pathname);
      status(`ä¿å­˜ä¸­: ${path}`);
    }catch(e){status(`âš ï¸ å¤±æ•—: ${url}`);}
  }

  // --- index.html ---
  const htmlFinal=new XMLSerializer().serializeToString(doc);
  zip.file("index.html",htmlFinal);

  // --- PDFç”Ÿæˆ ---
  status("ğŸ“ PDFç”Ÿæˆä¸­...");
  const tmp=document.createElement("iframe");
  tmp.style.position="fixed";tmp.style.left="-9999px";
  document.body.appendChild(tmp);
  const b=new Blob([htmlFinal],{type:"text/html"});
  tmp.src=URL.createObjectURL(b);

  const pdfBlob=await new Promise(resolve=>{
    tmp.onload=async()=>{
      try{
        const pdf=await html2pdf().set({
          html2canvas:{scale:2,useCORS:true},
          jsPDF:{format:"a4"}
        }).from(tmp.contentDocument.body).outputPdf("blob");
        resolve(pdf);
      }catch(e){
        status("âš ï¸ PDFç”Ÿæˆå¤±æ•—");
        resolve(null);
      }
      tmp.remove();
    };
  });

  if(pdfBlob){
    zip.file("page.pdf",pdfBlob);
    status("âœ… PDFç”Ÿæˆå®Œäº†");
  }

  // --- ZIPå‡ºåŠ› ---
  const blob=await zip.generateAsync({type:"blob"});
  const name=new URL(currentURL).hostname.replace(/\W+/g,"_")+"-complete.zip";
  saveAs(blob,name);
  status("ğŸ‰ å®Œæˆï¼ HTMLï¼‹PDF ZIPä¿å­˜å®Œäº†");
}

async function fetchResource(url){
  try{
    const r=await fetch(url);
    if(r.ok)return await r.blob();
  }catch(e){}
  for(let p of proxies){
    try{
      const r=await fetch(p+encodeURIComponent(url));
      if(r.ok)return await r.blob();
    }catch(e){}
  }
  throw new Error("å–å¾—å¤±æ•—");
}
</script>
</body>
</html>
